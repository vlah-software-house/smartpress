{{/* Copyright (c) 2026 Madalin Gabriel Ignisca <hi@madalin.me> */}}
{{/* Copyright (c) 2026 Vlah Software House SRL <contact@vlah.sh> */}}
{{/* All rights reserved. See LICENSE for details. */}}
{{define "title"}}{{if .Data.IsNew}}New{{else}}Edit{{end}} Template{{end}}

{{define "content"}}
<div class="max-w-4xl space-y-6" x-data="templateEditor()">
    {{if .Data.Error}}
    <div class="rounded-md bg-red-50 border border-red-200 p-4">
        <p class="text-sm text-red-800">{{.Data.Error}}</p>
    </div>
    {{end}}

    <form method="POST"
          {{if .Data.IsNew}}
          action="/admin/templates"
          {{else}}
          action="/admin/templates/{{.Data.Item.ID}}"
          hx-put="/admin/templates/{{.Data.Item.ID}}"
          {{end}}
          hx-target="#main-content"
          class="space-y-6">
        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

        <!-- Name and Type -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Template Name</label>
                    <input type="text" id="name" name="name" required
                           value="{{if .Data.Item}}{{.Data.Item.Name}}{{end}}"
                           class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm
                                  placeholder-gray-400 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 focus:outline-none"
                           placeholder="e.g., Default Page Layout">
                </div>

                <div>
                    <label for="type" class="block text-sm font-medium text-gray-700">Type</label>
                    {{if .Data.IsNew}}
                    <select id="type" name="type" required x-model="templateType"
                            class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm
                                   focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 focus:outline-none">
                        <option value="header" {{if and .Data.Item (eq (printf "%s" .Data.Item.Type) "header")}}selected{{end}}>Header</option>
                        <option value="footer" {{if and .Data.Item (eq (printf "%s" .Data.Item.Type) "footer")}}selected{{end}}>Footer</option>
                        <option value="page" {{if and .Data.Item (eq (printf "%s" .Data.Item.Type) "page")}}selected{{end}}>Page</option>
                        <option value="article_loop" {{if and .Data.Item (eq (printf "%s" .Data.Item.Type) "article_loop")}}selected{{end}}>Article Loop</option>
                    </select>
                    {{else}}
                    <input type="text" disabled
                           value="{{.Data.Item.Type}}"
                           class="mt-1 block w-full rounded-md border border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-500">
                    {{end}}
                </div>
            </div>

            <!-- Help text -->
            <div class="p-3 bg-blue-50 border border-blue-200 rounded-md text-xs text-blue-800">
                <p class="font-medium mb-1">Available template variables:</p>
                <p><strong>Page templates:</strong>
                    <code>{{"{{"}} .Title {{"}}"}}</code>,
                    <code>{{"{{"}} .Body {{"}}"}}</code>,
                    <code>{{"{{"}} .Header {{"}}"}}</code>,
                    <code>{{"{{"}} .Footer {{"}}"}}</code>,
                    <code>{{"{{"}} .Excerpt {{"}}"}}</code>,
                    <code>{{"{{"}} .MetaDescription {{"}}"}}</code>,
                    <code>{{"{{"}} .MetaKeywords {{"}}"}}</code>,
                    <code>{{"{{"}} .FeaturedImageURL {{"}}"}}</code>,
                    <code>{{"{{"}} .FeaturedImageSrcset {{"}}"}}</code>,
                    <code>{{"{{"}} .FeaturedImageAlt {{"}}"}}</code>,
                    <code>{{"{{"}} .SiteName {{"}}"}}</code>,
                    <code>{{"{{"}} .Year {{"}}"}}</code>,
                    <code>{{"{{"}} .Slug {{"}}"}}</code>,
                    <code>{{"{{"}} .PublishedAt {{"}}"}}</code>
                </p>
                <p class="mt-1"><strong>Article loop:</strong>
                    <code>{{"{{"}} range .Posts {{"}}"}}</code> with
                    <code>{{"{{"}} .Title {{"}}"}}</code>,
                    <code>{{"{{"}} .Slug {{"}}"}}</code>,
                    <code>{{"{{"}} .Excerpt {{"}}"}}</code>,
                    <code>{{"{{"}} .FeaturedImageURL {{"}}"}}</code>,
                    <code>{{"{{"}} .FeaturedImageSrcset {{"}}"}}</code>,
                    <code>{{"{{"}} .FeaturedImageAlt {{"}}"}}</code>,
                    <code>{{"{{"}} .PublishedAt {{"}}"}}</code>
                </p>
                <p class="mt-1"><strong>Header / Footer:</strong>
                    <code>{{"{{"}} .SiteName {{"}}"}}</code>,
                    <code>{{"{{"}} .Year {{"}}"}}</code>
                </p>
            </div>
        </div>

        <!-- HTML Content Editor -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <label for="html_content" class="block text-sm font-medium text-gray-700 mb-2">
                HTML + TailwindCSS Template
            </label>
            <textarea id="html_content" name="html_content" rows="20" required x-ref="editor"
                      class="block w-full rounded-md border border-gray-300 px-3 py-2 text-sm font-mono shadow-sm
                             placeholder-gray-400 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 focus:outline-none"
                      placeholder="Paste your HTML + TailwindCSS template here...">{{if .Data.Item}}{{.Data.Item.HTMLContent}}{{end}}</textarea>
        </div>

        <!-- AI Improve -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <button type="button" @click="aiOpen = !aiOpen"
                    class="w-full flex items-center justify-between px-6 py-4 hover:bg-gray-50 transition-colors">
                <div class="flex items-center gap-2">
                    <svg class="h-5 w-5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.455 2.456L21.75 6l-1.036.259a3.375 3.375 0 0 0-2.455 2.456Z" />
                    </svg>
                    <span class="text-sm font-medium text-gray-900">AI Improve</span>
                    <span class="text-xs text-gray-500">Describe changes and AI will update the template</span>
                </div>
                <svg class="h-4 w-4 text-gray-400 transition-transform" :class="aiOpen && 'rotate-180'" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                </svg>
            </button>

            <div x-show="aiOpen" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-150" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
                <div class="border-t border-gray-200 p-6 space-y-4">
                    <!-- Chat messages -->
                    <div x-show="aiMessages.length > 0" x-ref="aiChat"
                         class="space-y-3 max-h-[300px] overflow-y-auto">
                        <template x-for="(msg, idx) in aiMessages" :key="idx">
                            <div :class="msg.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
                                <div :class="msg.role === 'user'
                                        ? 'bg-indigo-600 text-white rounded-lg rounded-br-sm px-3 py-2 max-w-[85%]'
                                        : 'bg-gray-100 text-gray-800 rounded-lg rounded-bl-sm px-3 py-2 max-w-[85%]'">
                                    <p class="text-sm whitespace-pre-wrap" x-text="msg.content"></p>
                                </div>
                            </div>
                        </template>

                        <template x-if="aiLoading">
                            <div class="flex justify-start">
                                <div class="bg-gray-100 rounded-lg rounded-bl-sm px-3 py-2">
                                    <div class="flex items-center gap-2">
                                        <svg class="animate-spin h-4 w-4 text-indigo-500" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                        </svg>
                                        <span class="text-xs text-gray-500">Improving template...</span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Input -->
                    <div class="flex gap-2">
                        <input type="text" x-model="aiPrompt" :disabled="aiLoading"
                               @keydown.enter.prevent="aiImprove()"
                               placeholder="e.g., Make the header sticky, add a dark mode toggle, improve mobile layout..."
                               class="flex-1 rounded-md border border-gray-300 px-3 py-2 text-sm shadow-sm
                                      placeholder-gray-400 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 focus:outline-none
                                      disabled:bg-gray-50 disabled:text-gray-400">
                        <button type="button" @click="aiImprove()" :disabled="aiLoading || !aiPrompt.trim()"
                                class="rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-500
                                       transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <span x-text="aiLoading ? 'Working...' : 'Improve'"></span>
                        </button>
                    </div>

                    <p class="text-xs text-gray-400">AI will read your current template and apply the requested changes. You can undo by pressing Ctrl+Z in the editor.</p>
                </div>
            </div>
        </div>

        <!-- Preview -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-2">
                <label class="block text-sm font-medium text-gray-700">Live Preview</label>
                <div class="flex items-center gap-3">
                    <select x-model="previewContentID" @change="refreshFormPreview()"
                            class="rounded-md border border-gray-300 px-2 py-1 text-xs shadow-sm
                                   focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 focus:outline-none">
                        <option value="">Sample data</option>
                        <template x-for="c in previewContent" :key="c.id">
                            <option :value="c.id" x-text="c.title + ' (' + c.type + ')'"></option>
                        </template>
                    </select>
                    <button type="button" @click="refreshFormPreview()"
                            class="text-sm text-indigo-600 hover:text-indigo-800">
                        Refresh Preview
                    </button>
                </div>
            </div>
            <div id="preview-frame" class="border border-gray-200 rounded-md bg-white min-h-[200px] p-4">
                <p class="text-sm text-gray-400 text-center">Click "Refresh Preview" to see your template rendered with sample data.</p>
            </div>
        </div>

        <!-- Actions -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-end gap-3">
                <a href="/admin/templates"
                   hx-get="/admin/templates"
                   hx-target="#main-content"
                   hx-push-url="true"
                   class="rounded-md px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 border border-gray-300 shadow-sm transition-colors">
                    Cancel
                </a>
                <button type="submit"
                        class="rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-500 transition-colors">
                    {{if .Data.IsNew}}Create Template{{else}}Update Template{{end}}
                </button>
            </div>
        </div>
    </form>
</div>

<script>
function templateEditor() {
    return {
        templateType: '{{if and .Data.Item}}{{printf "%s" .Data.Item.Type}}{{else}}page{{end}}',
        aiOpen: false,
        aiPrompt: '',
        aiMessages: [],
        aiLoading: false,
        previewContentID: '',
        previewContent: [],

        init() {
            this.loadPreviewContent();
        },

        async loadPreviewContent() {
            try {
                const resp = await fetch('/admin/ai/preview-content');
                this.previewContent = await resp.json();
            } catch (err) {
                console.warn('Failed to load preview content:', err);
                this.previewContent = [];
            }
        },

        refreshFormPreview() {
            const values = { html_content: this.$refs.editor.value, template_type: this.templateType };
            if (this.previewContentID) {
                values.content_id = this.previewContentID;
            }
            htmx.ajax('POST', '/admin/templates/preview', {
                target: '#preview-frame',
                values: values
            });
        },

        async aiImprove() {
            const text = this.aiPrompt.trim();
            if (!text || this.aiLoading) return;

            const currentHTML = this.$refs.editor.value;
            if (!currentHTML.trim()) {
                this.aiMessages.push({ role: 'assistant', content: 'The template editor is empty. Write some HTML first, or use the AI Template Builder to generate a template from scratch.' });
                return;
            }

            this.aiMessages.push({ role: 'user', content: text });
            this.aiPrompt = '';
            this.aiLoading = true;

            this.$nextTick(() => {
                if (this.$refs.aiChat) {
                    this.$refs.aiChat.scrollTop = this.$refs.aiChat.scrollHeight;
                }
            });

            try {
                const csrfToken = document.querySelector('[hx-headers]')?.getAttribute('hx-headers');
                const csrf = csrfToken ? JSON.parse(csrfToken)['X-CSRF-Token'] : '';

                const formData = new FormData();
                formData.append('prompt', text);
                formData.append('template_type', this.templateType);
                formData.append('current_html', currentHTML);

                const resp = await fetch('/admin/ai/generate-template', {
                    method: 'POST',
                    headers: { 'X-CSRF-Token': csrf },
                    body: formData
                });

                const data = await resp.json();

                if (data.error) {
                    this.aiMessages.push({ role: 'assistant', content: 'Error: ' + data.error });
                } else if (data.html) {
                    this.$refs.editor.value = data.html;
                    this.$refs.editor.dispatchEvent(new Event('input', { bubbles: true }));

                    let msg = data.message || 'Template updated.';
                    if (!data.valid && data.validation_error) {
                        msg += '\n\nWarning: ' + data.validation_error;
                    }
                    this.aiMessages.push({ role: 'assistant', content: msg });

                    // Auto-refresh preview with content selector context.
                    this.refreshFormPreview();
                } else {
                    this.aiMessages.push({ role: 'assistant', content: data.message || 'No changes were generated.' });
                }
            } catch (err) {
                this.aiMessages.push({ role: 'assistant', content: 'Network error: ' + err.message });
            } finally {
                this.aiLoading = false;
                this.$nextTick(() => {
                    if (this.$refs.aiChat) {
                        this.$refs.aiChat.scrollTop = this.$refs.aiChat.scrollHeight;
                    }
                });
            }
        }
    };
}
</script>
{{end}}
