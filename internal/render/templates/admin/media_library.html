{{/* Copyright (c) 2026 Madalin Gabriel Ignisca <hi@madalin.me> */}}
{{/* Copyright (c) 2026 Vlah Software House SRL <contact@vlah.sh> */}}
{{/* All rights reserved. See LICENSE for details. */}}
{{define "title"}}{{.Title}}{{end}}

{{define "content"}}
<div x-data="mediaLibrary()">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">Media Library</h2>
            <p class="mt-1 text-sm text-gray-500">Upload and manage images and files.</p>
        </div>

        {{if not .Data.NoStorage}}
        <button @click="showUpload = true"
                class="inline-flex items-center gap-2 rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500">
            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
            </svg>
            Upload
        </button>
        {{end}}
    </div>

    {{if .Data.NoStorage}}
    <!-- No storage configured -->
    <div class="rounded-lg border-2 border-dashed border-gray-300 p-12 text-center">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
        </svg>
        <h3 class="mt-2 text-sm font-semibold text-gray-900">Object storage not configured</h3>
        <p class="mt-1 text-sm text-gray-500">Set S3_ENDPOINT, S3_ACCESS_KEY, and S3_SECRET_KEY in your environment to enable media uploads.</p>
    </div>
    {{else}}

    <!-- Upload modal -->
    <div x-show="showUpload" x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="showUpload = false"></div>
        <div class="flex min-h-full items-center justify-center p-4">
            <div class="relative bg-white rounded-lg shadow-xl w-full max-w-lg p-6"
                 @click.stop>
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Upload File</h3>

                <!-- Drop zone -->
                <div class="border-2 border-dashed rounded-lg p-8 text-center transition-colors"
                     :class="dragOver ? 'border-indigo-500 bg-indigo-50' : 'border-gray-300'"
                     @dragover.prevent="dragOver = true"
                     @dragleave.prevent="dragOver = false"
                     @drop.prevent="handleDrop($event)">
                    <svg class="mx-auto h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909M3.75 21h16.5a1.5 1.5 0 0 0 1.5-1.5V4.5a1.5 1.5 0 0 0-1.5-1.5H3.75a1.5 1.5 0 0 0-1.5 1.5v15a1.5 1.5 0 0 0 1.5 1.5Z" />
                    </svg>
                    <p class="mt-2 text-sm text-gray-600">Drag & drop a file here, or</p>
                    <label class="mt-2 inline-flex items-center gap-1 cursor-pointer text-sm font-semibold text-indigo-600 hover:text-indigo-500">
                        browse
                        <input type="file" class="sr-only" @change="handleFileSelect($event)"
                               accept="image/*,.pdf,.svg">
                    </label>
                    <p class="mt-1 text-xs text-gray-400">Max 50 MB. Images, SVG, PDF.</p>
                </div>

                <!-- Alt text -->
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700">Alt text (optional)</label>
                    <input type="text" x-model="altText"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm px-3 py-2 border"
                           placeholder="Describe the image for accessibility">
                </div>

                <!-- Bucket selector -->
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700">Visibility</label>
                    <select x-model="bucket"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm px-3 py-2 border">
                        <option value="public">Public (direct URL access)</option>
                        <option value="private">Private (signed URL required)</option>
                    </select>
                </div>

                <!-- Selected file info -->
                <div x-show="selectedFile" class="mt-4 p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div class="text-sm">
                            <p class="font-medium text-gray-900" x-text="selectedFile?.name"></p>
                            <p class="text-gray-500" x-text="formatSize(selectedFile?.size)"></p>
                        </div>
                        <button @click="selectedFile = null" class="text-gray-400 hover:text-gray-500">
                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Upload progress -->
                <div x-show="uploading" class="mt-4">
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-indigo-600 h-2 rounded-full transition-all duration-300"
                             :style="'width: ' + uploadProgress + '%'"></div>
                    </div>
                    <p class="mt-1 text-xs text-gray-500 text-center" x-text="uploadProgress + '%'"></p>
                </div>

                <!-- Error -->
                <div x-show="uploadError" class="mt-4 p-3 bg-red-50 rounded-lg">
                    <p class="text-sm text-red-800" x-text="uploadError"></p>
                </div>

                <!-- Actions -->
                <div class="mt-6 flex justify-end gap-3">
                    <button @click="showUpload = false; resetUpload()"
                            class="rounded-md bg-white px-4 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button @click="upload()"
                            :disabled="!selectedFile || uploading"
                            class="rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span x-show="!uploading">Upload</span>
                        <span x-show="uploading">Uploading...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Media grid -->
    <div id="media-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
        {{range .Data.Items}}
        <div id="media-{{.ID}}" class="group relative bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-shadow">
            <!-- Thumbnail / icon -->
            <div class="aspect-square bg-gray-100 flex items-center justify-center overflow-hidden">
                {{if .IsImage}}
                    {{if .ThumbURL}}
                    <img src="{{.ThumbURL}}" alt="{{if .AltText}}{{.AltText}}{{else}}{{.OriginalName}}{{end}}"
                         class="w-full h-full object-cover">
                    {{else}}
                    <img src="{{.URL}}" alt="{{if .AltText}}{{.AltText}}{{else}}{{.OriginalName}}{{end}}"
                         class="w-full h-full object-cover">
                    {{end}}
                {{else}}
                <svg class="h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                </svg>
                {{end}}
            </div>

            <!-- Info -->
            <div class="p-2">
                <p class="text-xs font-medium text-gray-900 truncate" title="{{.OriginalName}}">{{.OriginalName}}</p>
                <p class="text-xs text-gray-500">{{.HumanSize}}</p>
            </div>

            <!-- Hover overlay with actions -->
            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition-all flex items-center justify-center gap-2 opacity-0 group-hover:opacity-100">
                {{if .URL}}
                <button onclick="copyToClipboard('{{.URL}}')"
                        class="p-2 bg-white rounded-full shadow-lg hover:bg-gray-100" title="Copy URL">
                    <svg class="h-4 w-4 text-gray-700" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 7.5V6.108c0-1.135.845-2.098 1.976-2.192.373-.03.748-.057 1.123-.08M15.75 18H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 0 0-1.123-.08M15.75 18.75v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5A3.375 3.375 0 0 0 6.375 7.5H5.25m11.9-3.664A2.251 2.251 0 0 0 15 2.25h-1.5a2.251 2.251 0 0 0-2.15 1.586m5.8 0c.065.21.1.433.1.664v.75h-6V4.5c0-.231.035-.454.1-.664M6.75 7.5H4.875c-.621 0-1.125.504-1.125 1.125v12c0 .621.504 1.125 1.125 1.125h14.25c.621 0 1.125-.504 1.125-1.125V16.5a9 9 0 0 0-9-9Z" />
                    </svg>
                </button>
                {{end}}
                <button hx-delete="/admin/media/{{.ID}}"
                        hx-target="#media-{{.ID}}"
                        hx-swap="outerHTML"
                        hx-confirm="Delete this file?"
                        class="p-2 bg-white rounded-full shadow-lg hover:bg-red-50" title="Delete">
                    <svg class="h-4 w-4 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                    </svg>
                </button>
            </div>
        </div>
        {{end}}
    </div>

    {{if not .Data.Items}}
    <div class="text-center py-12">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909M3.75 21h16.5a1.5 1.5 0 0 0 1.5-1.5V4.5a1.5 1.5 0 0 0-1.5-1.5H3.75a1.5 1.5 0 0 0-1.5 1.5v15a1.5 1.5 0 0 0 1.5 1.5Z" />
        </svg>
        <h3 class="mt-2 text-sm font-semibold text-gray-900">No media files</h3>
        <p class="mt-1 text-sm text-gray-500">Upload your first file to get started.</p>
    </div>
    {{end}}

    {{end}}
</div>

<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Brief visual feedback could be added here.
    });
}

function mediaLibrary() {
    return {
        showUpload: false,
        dragOver: false,
        selectedFile: null,
        altText: '',
        bucket: 'public',
        uploading: false,
        uploadProgress: 0,
        uploadError: '',

        handleDrop(event) {
            this.dragOver = false;
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                this.selectedFile = files[0];
                this.uploadError = '';
            }
        },

        handleFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                this.selectedFile = files[0];
                this.uploadError = '';
            }
        },

        formatSize(bytes) {
            if (!bytes) return '';
            if (bytes >= 1048576) return (bytes / 1048576).toFixed(1) + ' MB';
            if (bytes >= 1024) return Math.round(bytes / 1024) + ' KB';
            return bytes + ' B';
        },

        resetUpload() {
            this.selectedFile = null;
            this.altText = '';
            this.bucket = 'public';
            this.uploading = false;
            this.uploadProgress = 0;
            this.uploadError = '';
        },

        async upload() {
            if (!this.selectedFile) return;

            this.uploading = true;
            this.uploadError = '';
            this.uploadProgress = 0;

            const formData = new FormData();
            formData.append('file', this.selectedFile);
            formData.append('alt_text', this.altText);
            formData.append('bucket', this.bucket);

            try {
                const csrfToken = document.body.getAttribute('hx-headers');
                const csrf = csrfToken ? JSON.parse(csrfToken)['X-CSRF-Token'] : '';

                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/admin/media');
                xhr.setRequestHeader('X-CSRF-Token', csrf);

                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        this.uploadProgress = Math.round((e.loaded / e.total) * 100);
                    }
                };

                xhr.onload = () => {
                    if (xhr.status === 201) {
                        this.showUpload = false;
                        this.resetUpload();
                        // Reload the page to show the new file.
                        window.location.reload();
                    } else {
                        try {
                            const resp = JSON.parse(xhr.responseText);
                            this.uploadError = resp.error || 'Upload failed.';
                        } catch {
                            this.uploadError = 'Upload failed.';
                        }
                        this.uploading = false;
                    }
                };

                xhr.onerror = () => {
                    this.uploadError = 'Network error. Please try again.';
                    this.uploading = false;
                };

                xhr.send(formData);
            } catch (err) {
                this.uploadError = 'Upload failed: ' + err.message;
                this.uploading = false;
            }
        }
    };
}
</script>
{{end}}
